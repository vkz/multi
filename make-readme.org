#+OPTIONS: author:nil
#+OPTIONS: toc:nil
#+OPTIONS: prop:nil
#+OPTIONS: d:nil

#+EXPORT_FILE_NAME: README.org
#+TITLE: Multi-methods and multi-patterns for Emacs Lisp

#+PROPERTY: header-args :exports code :results none :cache no
#+PROPERTY: header-args:emacs-lisp :tangle ./test-readme.el
#+PROPERTY: header-args:emacs-lisp+ :noeval

* make-readme                                                      :noexport:

Simply run: =M-x org-babel-execute-buffer=

#+begin_src emacs-lisp :exports none :results output silent :eval yes :tangle no
  (defun mu-tangle-example ()
    (goto-char (point-min))
    (when (search-forward "=>" nil t)
      (goto-char (point-min))
      (let ((code nil))
        (condition-case eof
            (while t (push (read (current-buffer)) code))
          (end-of-file nil))
        (setq code (nreverse code))
        (erase-buffer)
        (dolist (ex (mapcar (lambda (e) (cons 'example e)) (seq-partition code 3)))
          (insert (pp-to-string ex))
          (newline)
          (newline)))))

  ;; hook that tangles an example into ert-tests
  (add-hook 'org-babel-tangle-body-hook #'mu-tangle-example)
  (message "README: `org-babel-tangle-body-hook' has been updated with `mu-tangle-example'")

  ;; export to README.org
  (require 'ox)
  (org-export-to-file 'org "README.org")

  ;; tangle examples into ert-tests
  (org-babel-tangle)

  ;; load tests
  (load-file "test-readme.el")

  ;; run tests
  (if noninteractive
      ;; exit emacs with 0 or 1 error-code
      (ert-run-tests-batch-and-exit nil)
    ;; test and show summary
    (ert t)
    (pop-to-buffer "*ert*"))
#+end_src

* test-readme                                                      :noexport:

#+begin_src emacs-lisp :exports none
  ;; -*- lexical-binding: t; -*-

  (require 'ert)
  (load-file "multi-patterns.el")

  (ert-delete-all-tests)

  (defmacro example (test _ expected)
    `(ert-deftest ,(intern (symbol-name (gensym "example"))) ()
       "test"
       (should (equal ,expected ,test))))

#+end_src

* Example

#+begin_src emacs-lisp

  (mu-case '(a b c)
    ((l 'a &rest tail) tail))
  =>
  '(b c)

#+end_src

* Another example

#+begin_src emacs-lisp

  (mu-case '(a b c)
    ((l 'a &rest tail) tail))
  =>
  '(b c)

#+end_src
